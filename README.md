# Example Kubernetes/Kustomize Configuration with support for profiles and flavours

## Purpose

One of the bits that cause most repetition in Kubernetes configurations is having different flavours of existing applications. While it can be managed to a certain level by using common config maps and sharing those between instances of the same application, at some point it requires duplication of entire instances for simple changes. Although there can be different solutions to this using Kustomize, I found that this solution worked best for my purposes, mainly because it only required defining Kubernetes objects with structure, instead of randomly patching existing objects one way or the other.

## Usage

This is not a real configuration that you can deploy. However, if you want to see the configuration generated by Kustomize, you can run the following command on the command line:

```bash
kubectl kustomize <production|development>
```

You can see for production it will create different config maps for `canary`, `live`, and `prio` flavours of `service-b`, while only creating a single instance of `service-a`. Also observe that it will **NOT** deploy a bare version of `service-b`. The kustomizations mainly focus on `service-b` and apply dfferent kustomizations depending on the environment and flavour. Also you can see that the namespace is set at the top level for each environment, and then applied to all resources in that environment.

## FAQ

### Why some things are defined as resources while some others are bases?

This can be confusing but the structure can be defined as this:

```
service-b (base, defined by applications/service-b/base/service-b.yaml
    |        and included as a resource from that directory)
    |
    `-> service-b-{canary,live,prio} (flavour, defined by applications/service-b/flavours/${flavour}.
            |                           Refers to the base as its base, so imports the resources there)
            |
            `-> service-b-{canary,live,prio} (environment specific version, defined in
                                                {environments/{production,development}/service-b/${flavour}
                                                Refers to the specific flavour as its base and then patches
                                                it to produce the final resource)
```

### Why use `patchesStrategicMerge` and not JSONPatch?

Because I find the idea of patching parts of objects randomly unmanagable in large scale deployment scenarios.

### This is stupid! You are stupid!

Well, you are always welcome to open a PR, and I am always free to close it if you don't fix your language.